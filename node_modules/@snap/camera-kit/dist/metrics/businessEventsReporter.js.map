{"version":3,"file":"businessEventsReporter.js","sourceRoot":"","sources":["../../src/metrics/businessEventsReporter.ts"],"names":[],"mappings":"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","sourcesContent":["import { v4 } from \"uuid\";\nimport type { Observable } from \"rxjs\";\nimport { catchError, combineLatestWith, from, fromEvent, map, merge, of, switchMap, take } from \"rxjs\";\nimport { Injectable } from \"@snap/ts-inject\";\nimport { entries } from \"../common/entries\";\nimport type { EventOfType } from \"../events/TypedCustomEvent\";\nimport type { EventsFromTarget } from \"../events/TypedEventTarget\";\nimport * as blizzard from \"../generated-proto/blizzard/cameraKitEvents\";\nimport { getLogger } from \"../logger/logger\";\nimport type { MetricsClient } from \"../clients/metricsClient\";\nimport { metricsClientFactory } from \"../clients/metricsClient\";\nimport type { CameraKitConfiguration } from \"../configuration\";\nimport { configurationToken } from \"../configuration\";\nimport type { RemoteConfiguration } from \"../remote-configuration/remoteConfiguration\";\nimport { remoteConfigurationFactory } from \"../remote-configuration/remoteConfiguration\";\nimport { IndexedDBPersistence } from \"../persistence/IndexedDBPersistence\";\nimport { ExpiringPersistence } from \"../persistence/ExpiringPersistence\";\nimport { convertDaysToSeconds } from \"../common/time\";\nimport type { ConnectionType } from \"../platform/platformInfo\";\nimport { getPlatformInfo } from \"../platform/platformInfo\";\nimport type { MetricsEventTarget } from \"./metricsEventTarget\";\nimport { metricsEventTargetFactory } from \"./metricsEventTarget\";\n\nconst logger = getLogger(\"BusinessEventsReporter\");\n\ntype Nullables<T> = { [K in keyof T]-?: undefined extends T[K] ? K : never }[keyof T];\ntype UndefinedToOptional<T> = Partial<Pick<T, Nullables<T>>> & Omit<T, Nullables<T>>;\n\ntype CameraKitBusinessEvents = EventsFromTarget<MetricsEventTarget>[\"detail\"];\n\ntype MakeBlizzardEvent<E> = Omit<E, \"name\"> & { cameraKitEventBase: blizzard.CameraKitEventBase };\n\ntype CreateEventData<EventType extends EventsFromTarget<MetricsEventTarget>[\"type\"]> = (\n    event: MakeBlizzardEvent<EventOfType<EventType, EventsFromTarget<MetricsEventTarget>>[\"detail\"]>\n) => [string, UndefinedToOptional<blizzard.ServerEventData>];\n\ntype EventHandlers = {\n    [EventType in EventsFromTarget<MetricsEventTarget>[\"type\"]]: CreateEventData<EventType>;\n};\n\n/**\n * Translate between an external metric name, which is exposed to SDK users, and an internal Blizzard event name,\n * property name, and constructor.\n *\n * It is very important that we do this, since the naming of these internal business events are unintuitive and will\n * not make sense to SDK users.\n *\n * For a full list of business events (using their internal names), see:\n * https://docs.google.com/document/d/1-kSzFWCWw9Qo3D08FR1_cqeHTsUtk9p3p3uOptzWDTY/\n */\ntype CameraKitBusinessEventMap = {\n    assetDownload: MakeBusinessEvent<blizzard.CameraKitAssetDownload>;\n    assetValidationFailed: MakeBusinessEvent<blizzard.CameraKitAssetValidationFailed>;\n    benchmarkComplete: MakeBusinessEvent<blizzard.CameraKitWebBenchmarkComplete>;\n    exception: MakeBusinessEvent<blizzard.CameraKitException>;\n    legalPrompt: MakeBusinessEvent<blizzard.CameraKitLegalPrompt>;\n    lensDownload: MakeBusinessEvent<blizzard.CameraKitLensDownload>;\n    lensView: MakeBusinessEvent<blizzard.CameraKitWebLensSwipe>;\n    lensWait: MakeBusinessEvent<blizzard.CameraKitLensSpin>;\n    lensContentValidationFailed: MakeBusinessEvent<blizzard.CameraKitLensContentValidationFailed>;\n    session: MakeBusinessEvent<blizzard.CameraKitSession>;\n};\n\ninterface AppVendorAndPartnerUuid {\n    appVendorUuid: string | undefined;\n    partnerUuid: string | undefined;\n}\n\nconst connectivityTypeMapping: Partial<Record<ConnectionType, blizzard.CameraKitConnectivityType>> = {\n    cellular: blizzard.CameraKitConnectivityType.CAMERA_KIT_CONNECTIVITY_TYPE_MOBILE,\n    bluetooth: blizzard.CameraKitConnectivityType.CAMERA_KIT_CONNECTIVITY_TYPE_BLUETOOTH,\n    wifi: blizzard.CameraKitConnectivityType.CAMERA_KIT_CONNECTIVITY_TYPE_WIFI,\n    unknown: blizzard.CameraKitConnectivityType.CAMERA_KIT_CONNECTIVITY_TYPE_UNKNOWN,\n    none: blizzard.CameraKitConnectivityType.CAMERA_KIT_CONNECTIVITY_TYPE_UNREACHABLE,\n};\n\nconst vendorUuidKey = \"vendorUuid\";\nconst vendorUuidExpiry = convertDaysToSeconds(60);\n\n/**\n * Retrieves or generates a vendor UUID (Universally Unique Identifier).\n *\n * @param persistence - The persistence storage interface where UUID is stored.\n * @returns {Promise<string | undefined>} - A Promise that resolves to the vendor UUID or undefined,\n * if any failure occurs or opt-in is not enabled.\n */\nconst getOrGenerateVendorUuid = async (persistence: ExpiringPersistence<string>): Promise<string | undefined> => {\n    try {\n        const storedUuid = await persistence.retrieve(vendorUuidKey);\n        if (storedUuid) {\n            return storedUuid;\n        }\n\n        const newUuid = v4();\n        await persistence.store(vendorUuidKey, newUuid);\n\n        return newUuid;\n    } catch (error) {\n        throw new Error(\"Failed to generate vendor UUID\");\n    }\n};\n\nfunction listenAndReport(\n    metricsEventTarget: MetricsEventTarget,\n    metricsClient: MetricsClient,\n    eventHandlers: EventHandlers,\n    appVendorAndPartnerUuid: Observable<AppVendorAndPartnerUuid>\n): void {\n    const sessionId = v4();\n    logger.log(`Session ID: ${sessionId}`);\n\n    // Blizzard convention is to start the sequenceId at 1.\n    let sequenceId = 1;\n\n    const makeBlizzardEvent = <E extends CameraKitBusinessEvents>(\n        event: E,\n        appVendorUuid: string | undefined,\n        partnerUuid: string | undefined\n    ): MakeBlizzardEvent<E> => {\n        const { sdkShortVersion, sdkLongVersion, lensCore, locale, origin, deviceModel, connectionType } =\n            getPlatformInfo();\n\n        const deviceConnectivity =\n            connectivityTypeMapping[connectionType!] ??\n            blizzard.CameraKitConnectivityType.CAMERA_KIT_CONNECTIVITY_TYPE_UNKNOWN;\n\n        return {\n            ...event,\n            cameraKitEventBase: blizzard.CameraKitEventBase.fromPartial({\n                kitEventBase: blizzard.KitEventBase.fromPartial({\n                    locale,\n                    kitVariant: blizzard.KitType.CAMERA_KIT_WEB,\n                    kitVariantVersion: sdkShortVersion,\n                    kitClientTimestampMillis: `${Date.now()}`,\n                }),\n                deviceCluster: \"0\",\n                cameraKitVersion: sdkLongVersion,\n                lensCoreVersion: lensCore.version,\n                deviceModel,\n                cameraKitVariant: blizzard.CameraKitVariant.CAMERA_KIT_VARIANT_PARTNER,\n                cameraKitFlavor: blizzard.CameraKitFlavor.CAMERA_KIT_FLAVOR_DEBUG,\n                // We overload appId, using the origin instead because it's nice and human-readable (our backed adds\n                // the true appId as oauth_client_id before forwarding events to Blizzard).\n                appId: origin,\n                deviceConnectivity,\n                sessionId,\n                appVendorUuid,\n                partnerUuid,\n            }),\n        };\n    };\n\n    const sendServerEvent = (\n        eventName: string,\n        eventData: UndefinedToOptional<blizzard.ServerEventData>\n    ): Promise<void> => {\n        const { osName: osType, osVersion } = getPlatformInfo();\n        return metricsClient.setBusinessEvents(\n            blizzard.ServerEvent.fromPartial({\n                eventName,\n                osType,\n                osVersion,\n                maxSequenceIdOnInstance: \"0\",\n                sequenceId: `${sequenceId++}`,\n                eventData,\n            })\n        );\n    };\n\n    // Add event listeners for each event type and turn those listeners into Observables\n    const metricsEvents = entries(eventHandlers).map(([eventType, createEventData]) =>\n        fromEvent(metricsEventTarget, eventType).pipe(map((event) => ({ event, createEventData })))\n    );\n\n    // Subscribe to all the metrics events and combine them with the app/partner IDs obtained\n    // from remote configuration -- this means we'll queue up any metrics events that occur\n    // before remote config is downloaded, and send them once that config is available.\n    merge(...metricsEvents)\n        .pipe(combineLatestWith(appVendorAndPartnerUuid))\n        .subscribe(([{ event, createEventData }, { appVendorUuid, partnerUuid }]) => {\n            // Safety: When iterating over object keys in a mapped type, we lose the association between the key type\n            // and the value type – at each iteration, the key type is a union of all possible keys and the value type\n            // is a union of all possible values. When the value is a function with an argument, and that argument\n            // depends on the key type (which is a union), the contravariance of the argument type means that the union\n            // becomes an intersection. In our case here, this means the compiler expects each argument to contain all\n            // properties from all event types. The cast is safe because the mapped `EventHandlers` type ensures that\n            // `createEventData` takes an argument of the type corresponding its key's `eventType`'s event detail.\n            const [eventName, eventData] = createEventData(\n                makeBlizzardEvent(event.detail, appVendorUuid, partnerUuid) as any\n            );\n            sendServerEvent(eventName, eventData);\n        });\n}\n\nexport type MakeBusinessEvent<E> = Omit<\n    {\n        [K in keyof E]: Exclude<E[K], undefined> extends Record<keyof any, any>\n            ? MakeBusinessEvent<Exclude<E[K], undefined>>\n            : E[K];\n    },\n    \"cameraKitEventBase\"\n>;\n\nfunction getAppVendorAndPartnerUuid(\n    configuration: CameraKitConfiguration,\n    remoteConfiguration: RemoteConfiguration\n): Observable<AppVendorAndPartnerUuid> {\n    const vendorAnalyticsPersistence = new ExpiringPersistence<string>(\n        () => vendorUuidExpiry,\n        new IndexedDBPersistence({ databaseName: \"VendorAnalytics\" })\n    );\n\n    return remoteConfiguration.getInitializationConfig().pipe(\n        take(1),\n\n        switchMap(({ appVendorUuidOptIn }) => {\n            const partnerUuid = configuration.analyticsId;\n            if (appVendorUuidOptIn) {\n                return from(getOrGenerateVendorUuid(vendorAnalyticsPersistence)).pipe(\n                    map((appVendorUuid) => ({ appVendorUuid, partnerUuid }))\n                );\n            }\n            return of({ appVendorUuid: undefined, partnerUuid });\n        }),\n\n        catchError((error) => {\n            logger.warn(`Failed to retrieve or generate vendor UUID.`, error);\n            return of({ appVendorUuid: undefined, partnerUuid: configuration.analyticsId });\n        })\n    );\n}\n\nexport type MakeTaggedBusinessEvent<K extends keyof CameraKitBusinessEventMap> = {\n    name: K;\n} & CameraKitBusinessEventMap[K];\n\nexport const businessEventsReporterFactory = Injectable(\n    \"businessEventsReporter\",\n    [\n        metricsEventTargetFactory.token,\n        metricsClientFactory.token,\n        configurationToken,\n        remoteConfigurationFactory.token,\n    ] as const,\n    (\n        metricsEventTarget: MetricsEventTarget,\n        metricsClient: MetricsClient,\n        configuration: CameraKitConfiguration,\n        remoteConfiguration: RemoteConfiguration\n    ) => {\n        const appVendorAndPartnerUuid = getAppVendorAndPartnerUuid(configuration, remoteConfiguration);\n\n        /**\n         * This defines a mapping from a business event's external name (the name we document in public\n         * API docs), to its internal representation as a Blizzard ServerEvent.\n         *\n         * It is important that we do this, since the naming of these internal business events are\n         * unintuitive and will not make sense to SDK users.\n         *\n         * To specify the internal event, we must give the ServerEvent's eventName, the specific property\n         *  name which contains the event data (this is a \"oneof\" property on ServerEvent), and use the\n         * correct event type's `fromPartial` method (this is generated from the ServerEvent protobuf).\n         *\n         * These events are documented here:\n         * https://docs.google.com/document/d/1-kSzFWCWw9Qo3D08FR1_cqeHTsUtk9p3p3uOptzWDTY/\n         *\n         * They are defined in code here:\n         * https://github.sc-corp.net/Snapchat/snapchat/tree/master/blizzard/schema/blizzard-schema/\n         *  codeGen/src/main/java/com/snapchat/analytics/schema/events/cameraKit\n         */\n        listenAndReport(\n            metricsEventTarget,\n            metricsClient,\n            {\n                assetDownload: (event) => [\n                    \"CAMERA_KIT_ASSET_DOWNLOAD\",\n                    { cameraKitAssetDownload: blizzard.CameraKitAssetDownload.fromPartial(event) },\n                ],\n                assetValidationFailed: (event) => [\n                    \"CAMERA_KIT_ASSET_VALIDATION_FAILED\",\n                    {\n                        cameraKitAssetValidationFailed: blizzard.CameraKitAssetValidationFailed.fromPartial(event),\n                    },\n                ],\n                benchmarkComplete: (event) => [\n                    \"CAMERA_KIT_WEB_BENCHMARK_COMPLETE\",\n                    {\n                        cameraKitWebBenchmarkComplete: blizzard.CameraKitWebBenchmarkComplete.fromPartial(event),\n                    },\n                ],\n                exception: (event) => [\n                    \"CAMERA_KIT_EXCEPTION\",\n                    { cameraKitException: blizzard.CameraKitException.fromPartial(event) },\n                ],\n                legalPrompt: (event) => [\n                    \"CAMERA_KIT_LEGAL_PROMPT\",\n                    { cameraKitLegalPrompt: blizzard.CameraKitLegalPrompt.fromPartial(event) },\n                ],\n                lensDownload: (event) => [\n                    \"CAMERA_KIT_LENS_DOWNLOAD\",\n                    { cameraKitLensDownload: blizzard.CameraKitLensDownload.fromPartial(event) },\n                ],\n                lensView: (event) => [\n                    \"CAMERA_KIT_WEB_LENS_SWIPE\",\n                    { cameraKitWebLensSwipe: blizzard.CameraKitWebLensSwipe.fromPartial(event) },\n                ],\n                lensWait: (event) => [\n                    \"CAMERA_KIT_LENS_SPIN\",\n                    { cameraKitLensSpin: blizzard.CameraKitLensSpin.fromPartial(event) },\n                ],\n                lensContentValidationFailed: (event) => [\n                    \"CAMERA_KIT_LENS_CONTENT_VALIDATION_FAILED\",\n                    {\n                        cameraKitLensContentValidationFailed:\n                            blizzard.CameraKitLensContentValidationFailed.fromPartial(event),\n                    },\n                ],\n                session: (event) => [\n                    \"CAMERA_KIT_SESSION\",\n                    { cameraKitSession: blizzard.CameraKitSession.fromPartial(event) },\n                ],\n            },\n            appVendorAndPartnerUuid\n        );\n    }\n);\n"]}